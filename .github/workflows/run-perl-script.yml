name: Sanitize MEO EPG XML

on:
  push:
    branches:
      - main  # Runs on push events to the 'main' branch
  schedule:
    - cron: '0 0 * * *'  # Runs the script every day at midnight UTC
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  sanitize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download compressed EPG XML (MEO OHA)
        run: |
          curl -L \
            -A "Mozilla/5.0" \
            -o meo.raw.xml.gz \
            https://raw.githubusercontent.com/moonlightz/meo-epg/refs/heads/master/meo_oha.xml.gz

      - name: Decompress XML
        run: |
          gunzip -c meo.raw.xml.gz > meo.raw.xml

      - name: Sanitize XML (HTML + entities)
        run: |
          perl -0777 -pe '
            # Remove invalid HTML line breaks
            s/<br\s*\/?>/ /gi;
            s/<\/br>/ /gi;
      
            # Normalize broken entities like "& amp;"
            s/&\s+(amp|lt|gt|quot|apos);/&$1;/gi;
      
            # Escape bare ampersands (NOT followed by a valid entity)
            s/&(?!(?:amp|lt|gt|quot|apos|#\d+);)/&amp;/g;
          ' meo.raw.xml > xmltv.xml
          
      - name: Install xmllint
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils

      - name: Validate XML
        run: |
          xmllint --noout xmltv.xml

      - name: Commit sanitized XML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Sanitize EPG XML (HTML + unescaped ampersands)"
          file_pattern: xmltv.xml
