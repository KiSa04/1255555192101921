name: Sanitize MEO EPG XML

on:
  push:
    branches:
      - main  # Runs on push events to the 'main' branch
  schedule:
    - cron: '0 0 * * *'  # Runs the script every day at midnight UTC
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  sanitize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download EPG XML
        run: |
          curl -L \
            -A "Mozilla/5.0" \
            -o meo.raw.xml \
            https://raw.githubusercontent.com/moonlightz/meo-epg/refs/heads/master/meo.xml

      - name: Sanitize XML (HTML + ampersands)
        run: |
          sed -E '
            # remove invalid HTML line breaks
            s/<br[[:space:]]*\/?>/ /gi;
            s/<\/br>/ /gi;

            # escape bare ampersands (not part of entities)
            s/&([^a-zA-Z#])/&amp;\1/g;
          ' meo.raw.xml > meo.sanitized.xml

      - name: Install xmllint
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils

      - name: Validate XML
        run: |
          xmllint --noout meo.sanitized.xml

      - name: Commit sanitized XML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Sanitize EPG XML (HTML + unescaped ampersands)"
          file_pattern: xmltv.xml
