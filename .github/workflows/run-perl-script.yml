name: Sanitize MEO EPG XML

on:
  push:
    branches:
      - main  # Runs on push events to the 'main' branch
  schedule:
    - cron: '0 0 * * *'  # Runs the script every day at midnight UTC
  workflow_dispatch:  # Allows manual triggering of the workflow

jobs:
  sanitize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download EPG XML
        run: |
          curl -L \
            -A "Mozilla/5.0" \
            -o meo.xml \
            https://raw.githubusercontent.com/moonlightz/meo-epg/refs/heads/master/meo.xml

      - name: Sanitize XML (remove invalid HTML)
        run: |
          sed -E '
            s/<br[[:space:]]*\/?>/ /gi;
            s/<\/br>/ /gi;
          ' meo.xml > meo.sanitized.xml

      - name: Validate XML
        run: |
          sudo apt-get update
          sudo apt-get install -y libxml2-utils
          xmllint --noout meo.sanitized.xml

      - name: Commit sanitized XML
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Sanitize EPG XML (remove invalid HTML)"
          file_pattern: meo.sanitized.xml
